<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>title</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.css" />
    <link rel="stylesheet" href="https://cdn.firebase.com/libs/firepad/1.4.0/firepad.css" />
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.css" />
    <style>
      html { height: 100%; }
      body { margin: 0; height: 100%; position: relative; }
      /* Height / width / positioning can be customized for your use case.
       For demo purposes, we make firepad fill the entire browser. */
      #firepad-container {
         width: 100%;
         height: 50%;
         overflow-y: auto;
       }

       .firepad {
         width: 100%;
         height:50%;
       }

       .section {
         width: 100%;
         height:50%;
       }
    </style>

    <style type="text/css">
    .video-container * {
        -webkit-box-sizing: content-box;
        -moz-box-sizing: content-box;
        box-sizing: content-box;
      }
      .video-container iframe, .video-container .nascent-player {
        width: 100%;
        height: 375px;
      }
    </style>
  </head>
  <body onload="initialize()">
    <div id ="auth-container"></div>
    <div id="firepad-container"></div>
    <div id="video-container">
      <div id="player"></div>
      <div id="controls"></div>
    </div>

    <script type="text/javascript" src="MediasitePlayerIFrameAPI.js"></script>
    <script type="text/javascript" src="MediasitePlayerControls.js"></script>

    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-auth.js"></script>

    <!-- Code Mirror - the editor used in this page for firepad-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.js"></script>

    <!-- firebase ui -->
    <script src="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.js"></script>

    <!-- Firepad -->
    <script src="https://cdn.firebase.com/libs/firepad/1.4.0/firepad.min.js"></script>

    <script>

      var url = "https://sofo.mediasite.com/Mediasite/Play/d64d7806bcc14f95a3c57633bcfd30c31d";
      var player;
      var controls;
      //TODO: Make transcriptKey global instead of passing it around


      // Initialize firebase so that database references can be made
      function initialize() {

        console.log("Init called");
        var config = {
          apiKey: "AIzaSyC_PcyEemJampMIHiefh94vw9eMpoaYDGI",
          authDomain: "test-project-96190.firebaseapp.com",
          databaseURL: "https://test-project-96190.firebaseio.com",
          projectId: "test-project-96190",
          storageBucket: "test-project-96190.appspot.com",
          messagingSenderId: "807025189838"
        };

        firebase.initializeApp(config);

        console.log("Firebase initialized");

        //var firepadRef = getExampleRef();

        console.log("Got firepad reference");

        var uiConfig = {
          signInSuccessUrl: '/',
          signInOptions: [
            // Leave the lines as is for the providers you want to offer your users.
            firebase.auth.GoogleAuthProvider.PROVIDER_ID,
          ],
          // Terms of service url.
          tosUrl: 'google.com'
        };

        // Initialize the FirebaseUI Widget using Firebase.
        var ui = new firebaseui.auth.AuthUI(firebase.auth());
        // The start method will wait until the DOM is loaded.
        ui.start('#auth-container', uiConfig);

        console.log("Getting the player reference");
        getPlayerReference(start);
        //var codeMirror = CodeMirror(document.getElementById('firepad-container'), { linewrapping: true});

        //console.log("Build code mirror object");

        /*var firepad = Firepad.fromCodeMirror(firepadRef, codeMirror,
          {richTextToolbar: true, richTextShortcuts: true});

        firepad.on('ready', function() {
          if (firepad.isHistoryEmpty()) {
            firepad.setHtml(
              '<span style="font-size: 24px;"> Rich text editing with <span style="color:red">Firepad!</span></span><br/><br/>Collaborative-editing made easy.\n');
          }
        });*/
      }

      //Example function kept here for reference
      function getExampleRef() {
        var ref = firebase.database().ref();
        var hash = window.location.hash.replace(/#/g, '');
        if (hash) {
          ref = ref.child(hash);
        }

        else {
          ref = ref.push();
          window.location = window.location + '#' + ref.key;
        }

        if(typeof console !== undefined) {
          console.log('Firebase data: ', ref.toString());
        }

        return ref;
      }

      //TODO: Manage user IDs correctly here
      function addFirePadElement(firepadRef, caption) {
        var container = document.getElementById("firepad-container");
        var divElement = document.createElement('div');
        divElement.setAttribute('id', firepadRef.key);
        divElement.classList.add("section");
        container.appendChild(divElement);
        var codeMirrorBox = CodeMirror(divElement, {linewrapping: true});
        var firepadBox = Firepad.fromCodeMirror(firepadRef, codeMirrorBox,
          {richTextToolbar: false, richTextShortcuts: false});

        //Set initial text to original caption text
        firepadBox.on('ready', function() {
          if (firepadBox.isHistoryEmpty()) {
            firepadBox.setText(caption.text);
          }
        });

        return firepadBox;
      }


      //Adds a caption entry to the database with a specific ID
      function addCaption(caption, transcriptKey) {
        var captionRef = firebase.database().ref("/captions/" + transcriptKey).push();
        captionRef.set({
          time: caption.time
        });
        return captionRef.key;
      }

      //Need to check if i can preset the current text in the firepad objects
      //Before calling Firepad.fromCodeMirror, I think I can? Can't need to manually set
      function addFirePadRef(transcriptKey, captionKey) {
        var firepadRef = firebase.database().ref("/firepads/" + transcriptKey + "/" + captionKey);
        return firepadRef;
      }

      //Gets the player, callback will be called when the video player loads,
      //so that anything function involving the player's captions can be called
      function getPlayerReference(callback) {
        player = new Mediasite.Player( "player",
          {
            url: url + (url.indexOf("?") == -1 ? "?" : "&") + "player=MediasiteIntegration",
            events: {
                          "ready":   callback
                    }
          });

        controls = new Mediasite.PlayerControls(player, "controls",
          {
            imageSprite: "url(MediasitePlayerControls.png)"
          });
      }

      //Initializes a transcript for the first time, adds the neccessary objects
      //to the database
      function initializeTranscript() {
        var transcriptKey = firebase.database().ref().push().key;
        window.location = window.location + '#' + transcriptKey;

        var captions = player.getCaptions();
        //captions = captions.slice(0,5);

        for (var i = 0; i < captions.length; i++) {
          var caption = captions[i];
          var captionKey = addCaption(caption, transcriptKey);
          var firepadRef = addFirePadRef(transcriptKey, captionKey);
          var firepadBox = addFirePadElement(firepadRef, caption);

        }
      }

      // Loads in Firepad elements for side menu in current TIME ORDER
      function loadTranscript(transcriptKey) {
          var captions = firebase.database().ref("/captions/" + transcriptKey).orderByChild("time");
          captions.once('value').then(
            function(snapshot) {
              for (key in snapshot.val()) {
                var firepadRef = addFirePadRef(firebase.database().ref("/firepads/"+ transcriptKey + "/" + key));
                addFirePadElement(firepadRef);
              }
            }
          )
      }

      //Finds the hash in web url and either loads a transcript or creates a new one
      //if there is no hash
      function start() {
        var ref = firebase.database().ref("/captions/");
        var hash = window.location.hash.replace(/#/g, '');
        if (hash && checkExistence(ref.child(hash))) {
          loadTranscript(hash);
        }
        else {
          initializeTranscript();
        }
      }

      function scrollToCaption(captionKey) {
          var firepadContainer = document.getElementById("firepad-container");
          var textBox = document.getElementById(captionKey);
          var offset = textBox.offsetTop;
          firepadContainer.scrollTop = offset;
      }

      //TODO: Add update to current caption here (postpone this for now)
      function addCaptionListener() {

      }

      function checkExistence(dataRef) {
        dataRef.once('value', function(snapshot) {
          return (snapshot.val() !== null);
        })
      }

    </script>
  </body>
</html>
